name: Plan
description: GCP Plan

inputs:
  CLOUD:
    required: true
    description: GCP Cloud
  ENV:
    required: true
    description: GCP Env
  REGION:
    required: true
    description: GCP Region
  PROJECT_ID:
    required: true
    description: GCP Project ID
  POOL:
    required: true
    description: GCP Pool
  PROVIDER:
    required: true
    description: GCP Provider
  SERVICE_ACCOUNT:
    required: true
    description: GCP Service Account
  GOOGLE_CREDENTIALS:
    required: true
    description: GCP CREDENTIALS

runs:
  using: "composite"
  steps:
    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: ${{ inputs.GOOGLE_CREDENTIALS }}
        # project_id: '${{ inputs.PROJECT_ID }}'
        # workload_identity_provider: 'projects/${{ inputs.PROJECT_ID }}/locations/global/workloadIdentityPools/${{ inputs.POOL }}/providers/${{ inputs.PROVIDER }}'
        # service_account: '${{ inputs.SERVICE_ACCOUNT }}'

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'
      with:
        version: '>= 363.0.0'

    - name: 'Use gcloud CLI'
      shell: bash
      run: 'gcloud info'

    - name: GCP Setup
      id: gcp-setup
      shell: bash
      run: |
        mv terragrunt.gcp.hcl terragrunt.hcl

    - name: Plan
      id: terragrunt-plan
      shell: bash
      working-directory: ${{ inputs.CLOUD }}/${{ inputs.REGION }}/${{ inputs.ENV }}/
      run: |
        terragrunt run-all init
        terragrunt run-all plan -no-color --terragrunt-non-interactive --terragrunt-include-external-dependencies | tee plan-${{ inputs.CLOUD }}${{ inputs.REGION }}-${{ inputs.ENV }}.txt

    - uses: actions/upload-artifact@v3
      with:
        name: terragrunt
        path: ${{ inputs.CLOUD }}/${{ inputs.REGION }}/${{ inputs.ENV }}/plan-${{ inputs.ENV }}.txt
